{% extends "base.html" %}

{% block title %}管理员后台 - MyWeb{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: none;
        border-radius: 10px;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .stat-card {
        border-radius: 10px;
        overflow: hidden;
    }
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        line-height: 1;
    }
    .quick-action-btn {
        border-radius: 8px;
        padding: 12px;
        font-weight: 500;
    }
    .card-header-gradient {
        background: linear-gradient(135deg, var(--header-color), color-mix(in srgb, var(--header-color) 80%, black));
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">
                <i class="fas fa-cog text-primary me-2"></i>
                管理员控制台
            </h1>
            <p class="text-muted mb-0">系统管理和监控面板</p>
        </div>
        <div class="d-flex align-items-center">
            <span class="badge bg-info me-3">
                <i class="fas fa-user-shield me-1"></i>管理员模式
            </span>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                        data-bs-toggle="dropdown">
                    <i class="fas fa-user-cog me-2"></i>{{ current_user.username }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{{ url_for('main.home') }}">
                        <i class="fas fa-home me-2"></i>返回主页
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('user.profile') }}">
                        <i class="fas fa-user me-2"></i>个人中心
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                        <i class="fas fa-sign-out-alt me-2"></i>退出登录
                    </a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 系统统计卡片 -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-1">
                                <i class="fas fa-users me-1"></i>总用户数
                            </h6>
                            <h2 class="stat-number text-primary mb-0">{{ total_users }}</h2>
                            <small class="text-muted">比上月增长 12%</small>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-users fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-1">
                                <i class="fas fa-user-check me-1"></i>活跃用户
                            </h6>
                            <h2 class="stat-number text-success mb-0">{{ active_users }}</h2>
                            <small class="text-muted">已验证邮箱用户</small>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-user-check fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-1">
                                <i class="fas fa-user-clock me-1"></i>未验证用户
                            </h6>
                            <h2 class="stat-number text-warning mb-0">{{ unverified_users }}</h2>
                            <small class="text-muted">7天前注册未验证</small>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-user-clock fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-1">
                                <i class="fas fa-user-shield me-1"></i>管理员
                            </h6>
                            <h2 class="stat-number text-info mb-0">{{ admin_users }}</h2>
                            <small class="text-muted">系统管理员数量</small>
                        </div>
                        <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-user-shield fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 功能管理卡片 -->
    <div class="row mb-4">
        <!-- 用户管理 -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card dashboard-card h-100" style="--header-color: #0d6efd;">
                <div class="card-header card-header-gradient">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>用户管理
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">管理系统用户账户，包括查看用户信息、启用/禁用账户、权限管理等。</p>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="bg-light p-2 rounded text-center">
                                <small class="text-muted">今日新增</small>
                                <div class="fw-bold">3</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="bg-light p-2 rounded text-center">
                                <small class="text-muted">7日活跃</small>
                                <div class="fw-bold">{{ active_users }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <a href="#" class="btn btn-primary quick-action-btn">
                            <i class="fas fa-list me-2"></i>用户列表
                        </a>
                        <a href="#" class="btn btn-outline-primary quick-action-btn">
                            <i class="fas fa-search me-2"></i>搜索用户
                        </a>
                        <a href="/dev/cleanup-now" class="btn btn-outline-warning quick-action-btn">
                            <i class="fas fa-broom me-2"></i>清理未验证用户
                        </a>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        最后清理：{{ last_cleanup_time|default('从未清理') }}
                    </small>
                </div>
            </div>
        </div>

        <!-- 公告管理 -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card dashboard-card h-100" style="--header-color: #198754;">
                <div class="card-header card-header-gradient">
                    <h5 class="mb-0">
                        <i class="fas fa-bullhorn me-2"></i>公告管理
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">发布和管理系统公告，包括通知、更新、维护等信息的发布和管理。</p>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="bg-light p-2 rounded text-center">
                                <small class="text-muted">总公告数</small>
                                <div class="fw-bold">{{ announcements_count|default(0) }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="bg-light p-2 rounded text-center">
                                <small class="text-muted">今日发布</small>
                                <div class="fw-bold">1</div>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('announcements.admin_dashboard') }}" class="btn btn-success quick-action-btn">
                            <i class="fas fa-cog me-2"></i>公告管理
                        </a>
                        <a href="{{ url_for('announcements.create_announcement') }}" class="btn btn-outline-success quick-action-btn">
                            <i class="fas fa-plus me-2"></i>发布公告
                        </a>
                        <a href="{{ url_for('announcements.admin_announcement_list') }}" class="btn btn-outline-info quick-action-btn">
                            <i class="fas fa-list me-2"></i>所有公告
                        </a>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        最后更新：{{ last_announcement_time|default('暂无公告') }}
                    </small>
                </div>
            </div>
        </div>

        <!-- 系统设置 -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card dashboard-card h-100" style="--header-color: #0dcaf0;">
                <div class="card-header card-header-gradient">
                    <h5 class="mb-0">
                        <i class="fas fa-sliders-h me-2"></i>系统设置
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">配置系统参数，包括清理设置、邮件配置、权限管理、系统维护等。</p>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="bg-light p-2 rounded text-center">
                                <small class="text-muted">系统状态</small>
                                <div class="fw-bold text-success">运行中</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="bg-light p-2 rounded text-center">
                                <small class="text-muted">数据库</small>
                                <div class="fw-bold text-success">正常</div>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <a href="#" class="btn btn-info quick-action-btn">
                            <i class="fas fa-wrench me-2"></i>系统配置
                        </a>
                        <a href="/dev/cleanup-now" class="btn btn-outline-info quick-action-btn">
                            <i class="fas fa-broom me-2"></i>清理工具
                        </a>
                        <a href="#" class="btn btn-outline-secondary quick-action-btn">
                            <i class="fas fa-history me-2"></i>操作日志
                        </a>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <i class="fas fa-server me-1"></i>
                        服务器时间：{{ current_time|default('--:--') }}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- 快速操作和系统状态 -->
    <div class="row">
        <!-- 快速操作 -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>快速操作
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3 col-6">
                            <a href="{{ url_for('announcements.create_announcement') }}"
                               class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                                <i class="fas fa-plus fa-2x mb-2"></i>
                                <span>发布公告</span>
                            </a>
                        </div>
                        <div class="col-md-3 col-6">
                            <a href="{{ url_for('announcements.admin_announcement_list') }}"
                               class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                                <i class="fas fa-list fa-2x mb-2"></i>
                                <span>公告列表</span>
                            </a>
                        </div>
                        <div class="col-md-3 col-6">
                            <a href="{{ url_for('announcements.announcement_list') }}"
                               class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                                <i class="fas fa-eye fa-2x mb-2"></i>
                                <span>用户视角</span>
                            </a>
                        </div>
                        <div class="col-md-3 col-6">
                            <a href="/dev/cleanup-now"
                               class="btn btn-outline-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                                <i class="fas fa-broom fa-2x mb-2"></i>
                                <span>立即清理</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统状态 -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-heartbeat me-2"></i>系统状态
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-database me-2"></i>数据库连接</span>
                            <span class="badge bg-success">正常</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-envelope me-2"></i>邮件服务</span>
                            <span class="badge bg-success">正常</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-hdd me-2"></i>存储空间</span>
                            <span class="badge bg-info">85%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-memory me-2"></i>内存使用</span>
                            <span class="badge bg-warning">65%</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-clock me-2"></i>系统运行时间</span>
                            <span class="badge bg-secondary">2天15小时</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 最近活动 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>最近活动
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1"><i class="fas fa-user-plus text-success me-2"></i>新用户注册</h6>
                                <small class="text-muted">10分钟前</small>
                            </div>
                            <p class="mb-1">用户 "testuser" 通过邮箱注册</p>
                        </div>
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1"><i class="fas fa-bullhorn text-primary me-2"></i>公告发布</h6>
                                <small class="text-muted">2小时前</small>
                            </div>
                            <p class="mb-1">发布公告 "系统维护通知"</p>
                        </div>
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1"><i class="fas fa-broom text-warning me-2"></i>用户清理</h6>
                                <small class="text-muted">1天前</small>
                            </div>
                            <p class="mb-1">清理了3个未验证邮箱的用户</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 更新服务器时间
    function updateServerTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('zh-CN', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const dateStr = now.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });

        const timeElement = document.querySelector('.card-footer small:last-child');
        if (timeElement) {
            timeElement.innerHTML = `<i class="fas fa-server me-1"></i>服务器时间：${dateStr} ${timeStr}`;
        }
    }

    // 初始更新时间
    updateServerTime();

    // 每秒更新时间
    setInterval(updateServerTime, 1000);

    // 清理工具确认
    const cleanupBtn = document.querySelector('a[href="/dev/cleanup-now"]');
    if (cleanupBtn) {
        cleanupBtn.addEventListener('click', function(e) {
            if (!confirm('确定要立即执行清理吗？这将删除所有超过7天未验证的用户。')) {
                e.preventDefault();
            }
        });
    }

    // 卡片悬停效果
    const cards = document.querySelectorAll('.dashboard-card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.zIndex = '10';
        });

        card.addEventListener('mouseleave', function() {
            this.style.zIndex = '';
        });
    });
});
</script>
{% endblock %}